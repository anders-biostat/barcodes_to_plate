<head>
	<title>Read barcodes</title>
	<script type="text/javascript">
		var filters = [{
			name: "LC480 I (B)", 
			waves: "483-533,523-568,615-670"
		},{
			name: "LC480 II (A)", 
			waves: "465-510,533-580,618-660"
		},{
			name: "LC480 II (A) altona + Inlfuenza", 
			waves: "483-533,523-568,615-670"
		},{
			name: "LC480 II (A) FTD", 
			waves: "465-510,533-580,533-610,618-660"
		}];
	</script>
</head>
<body>
	<div>Open file with barcodes to well assignment.</div>
	<form  action="upload" method="post" enctype="multipart/form-data">
		<input type="file" name="barcodes" id="barcodes"/><button onclick="fileupload();" type="button">Upload file</button>
	</form>
	<div id="message"></div>
	<div>
		<button disabled class="saveButton" onclick="download('pdf');">Download pdf</button>
		<button disabled class="saveButton" onclick="download('csv');">Download LightCycler file</button>
	</div>
	<div>
		Select a set of filters for the LightCycler: <br>
		<select id="filterList" onchange="setWaves();">
			<option style="display: none;" id="customWave">Custom</option>
		</select><br>
		waves (comma separated): 
		<input type="text" id="waves" onchange="document.querySelector('#customWave').selected = true;">
	</div>
	<form action="store" method="post" enctype="multipart/form-data">
		<input type="text" name="pdf_name">	
		<input type="text" name="csv_name">
		<textarea></textarea>
		<textarea></textarea>
		<button type="button" disabled class="saveButton">Store output</button>
	</form>
	<script type="text/javascript">
		filters.forEach((el, i) => {
			let opt = document.createElement("option");
			opt.value = el.waves;
			opt.innerHTML = el.name;
			if(i == 0) opt.selected = true;
			document.querySelector("#filterList")
				.append(opt);
		});

		setWaves();
		

		function setWaves() {
			document.querySelector("#waves").value = document.querySelector("#filterList").value;	
		};

		function fileupload() {
			var files = document.getElementById("barcodes").files;
			if(files.length == 0) {
				document.getElementById("message").innerHTML = "No file is selected. Please, select a file first.";
				return;
			} else {
				document.getElementById("message").innerHTML = "";
			}
  		
  		const formData = new FormData()
  		formData.append('barcodes', files[0])
			
			fetch("/upload", {
				method: "post",
				body: formData
			})
			.then(res => {
				if(res.status == 406) {
					document.getElementById("message").innerHTML = "Empty file or wrong format";
					return;
				} else if(res.status == 200) {
					document.querySelectorAll(".saveButton")
						.forEach(el => {el.disabled = false;})
					return res.text();
				}
			})
			.then(text => {
				if(text) 
					document.getElementById("message").innerHTML = "File is loaded. " + text + " wells detected"
			})
		};

		var download = function(type) {
			let query = "type=" + type;
			if(type == "csv")
				query += "&waves=" + document.querySelector("#waves").value.replace(/ /g,'');
			
			fetch("/download?" + query)
		};

	</script>
</body>