<head>
	<title>Read barcodes</title>
	<script type="text/javascript">
		var filters = [{
			name: "LC480 I (B)", 
			waves: "483-533,523-568,615-670"
		},{
			name: "LC480 II (A)", 
			waves: "465-510,533-580,618-660"
		},{
			name: "LC480 II (A) altona + Inlfuenza", 
			waves: "483-533,523-568,615-670"
		},{
			name: "LC480 II (A) FTD", 
			waves: "465-510,533-580,533-610,618-660"
		}];
		var paths = {
			pdf: ["/home/tyranchick/Git/barcodes_to_plate/storePdf/"],
			csv: ["/home/tyranchick/Git/barcodes_to_plate/storeCsv1", 
						"/home/tyranchick/Git/barcodes_to_plate/storeCsv2"]
		}
	</script>
</head>
<body>
	<div>Open file with barcodes to well assignment.</div>
	<form  action="upload" method="post" enctype="multipart/form-data">
		<input type="file" name="barcodes" id="barcodes"/><button onclick="fileupload();" type="button">Upload file</button>
	</form>
	<div id="message"></div>
	<div>
		<button disabled class="saveButton" onclick="download('pdf');">Download pdf</button>
		<button disabled class="saveButton" onclick="download('csv');">Download LightCycler file</button>
	</div>
	<div>
		Select a set of filters for the LightCycler: <br>
		<select id="filterList" onchange="setWaves();">
			<option style="display: none;" id="customWave">Custom</option>
		</select><br>
		waves (comma separated): 
		<input type="text" id="waves" onchange="document.querySelector('#customWave').selected = true;">
	</div>
	<form action="store" method="post" enctype="multipart/form-data" id="store">
		<input type="text" name="pdf_name" class="name">	
		<input type="text" name="csv_name" class="name">
		<textarea id="pdf_paths"></textarea>
		<textarea id="csv_paths"></textarea>
		<div>Paths should be separated by line break</div>
		<button type="button" disabled class="saveButton" onclick="store()">Store output</button>
	</form>
	<script type="text/javascript">
		filters.forEach((el, i) => {
			let opt = document.createElement("option");
			opt.value = el.waves;
			opt.innerHTML = el.name;
			if(i == 0) opt.selected = true;
			document.querySelector("#filterList")
				.append(opt);
		});

		setWaves();

		["pdf", "csv"].forEach(type => {
			document.querySelector("#" + type + "_paths")
				.value  = paths[type].join('\n');
		})
		

		function setWaves() {
			document.querySelector("#waves").value = document.querySelector("#filterList").value;	
		};

		function fileupload() {
			var files = document.getElementById("barcodes").files;
			if(files.length == 0) {
				document.getElementById("message").innerHTML = "No file is selected. Please, select a file first.";
				return;
			} else {
				document.getElementById("message").innerHTML = "";
			}
  		
  		const formData = new FormData()
  		formData.append('barcodes', files[0])
			
			fetch("/upload", {
				method: "post",
				body: formData
			})
			.then(res => {
				if(res.status == 406) {
					document.getElementById("message").innerHTML = "Empty file or wrong format";
					return;
				} else if(res.status == 200) {
					document.querySelectorAll(".saveButton")
						.forEach(el => {el.disabled = false;});
					
					var d = new Date();
					var year = d.getFullYear().toString().substr(-2);
					var month = (d.getMonth() + 1).toString();
					if(month.length == 1) month = "0" + month;
					var day = d.getDate().toString();
					if(day.length == 1) day = "0" + day;

					var filename = document.querySelector("#barcodes").files[0].name
						.split(".")
						.slice(0, -1)
						.join(".");

					console.log(filename);

					document.querySelectorAll(".name").forEach(function(el) {
						let type = el.name.split("_")[0];

						el.value = year + month + day + "_" + filename + "." + type;
					});

					return res.text();
				}
			})
			.then(text => {
				if(text) 
					document.getElementById("message").innerHTML = "File is loaded. " + text + " wells detected"
			})
		};

		function download(type) {
			let query = "type=" + type;
			if(type == "csv")
				query += "&waves=" + document.querySelector("#waves").value.replace(/ /g,'');
			
			fetch("/download?" + query)
			.then(res => {
				if(res.ok) return res.blob();
			})
			.then(blob => {
				if(!blob){
					alert("Can't download file!");
					return;
				};
				var url = window.URL.createObjectURL(blob);
				var a = document.createElement('a');
				a.href = url;
				a.download = document.getElementsByName(type + "_name")[0].value || "output." + type;
				document.body.appendChild(a); 
				a.click();
				a.remove();
			});
		};

		function store() {
			["pdf", "csv"].forEach(type => {
				var name = document.getElementsByName(type + "_name")[0].value || "output." + type;

				document.querySelector("#" + type + "_paths")
					.value.split("\n")
					.map(el => el.trim())
					.forEach(path => {
						fetch("/store?path=" + path + "&type=" + type + "&name=" + name + 
							"&waves=" + document.querySelector("#waves").value.replace(/ /g,''))
						.then(res => {
							if(res.ok) 
								alert("File '" + name + "' stored to '" + path + "'")
							else
								alert("Can't store '" + name + "' to '" + path + "'");
						})
					});
			});
		}

	</script>
</body>